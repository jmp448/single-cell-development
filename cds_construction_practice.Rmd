---
title: "Playing w CDS Object"
output: cds_construction_.practice
---

Play with monocle cds creation
```{r}
library(stringr)
```

```{r}
rawdata <- '/project2/gilad/reem/singlecellCM/round1/fulldata/CD1/CD1col1/output/dge_data/YG-RE-RE1-hpCD1col1_S1_gene_counts.tsv.gz'
min_cells_per_gene = 3  # minimum num cells in which a gene must appear
min_genes_per_cell = 200  # minimum num genes for a cell to be included
cutoff_mito = FALSE  # wanna cut off cells w a certain percent mito? (bool)
mito_threshold = 30  # what is the threshold for mito cutoff?

```

```{r}
expression_matrix <- read.table(rawdata, header = T, stringsAsFactors = F, row.names = 1)

# remove the version numbers from those gene IDs
non_version_genes <- str_replace(rownames(expression_matrix), pattern = ".[0-9]+$", replacement = "")
rownames(expression_matrix) <- non_version_genes

# remove any duplicates (later versions, etc)
expression_matrix <- expression_matrix[!duplicated(rownames(expression_matrix)),]

# subset to only those genes from the full list of genes
geneinfo <- readRDS("./rds_objects/geneinfo.rds")

genes_present <- geneinfo[geneinfo$ensembl_gene_id %in% non_version_genes, ]
genes_present <- genes_present[!duplicated(genes_present$ensembl_gene_id), ]

expression_matrix <- expression_matrix[rownames(expression_matrix) %in% genes_present$ensembl_gene_id, ]

rm(non_version_genes)
```

Sort genes by ensemblID
```{r}
# sort by ensemblID
id_sort <- order(genes_present$ensembl_gene_id, decreasing=F)
genes_present <- genes_present[id_sort, ]
```

Handle duplicates in gene names (due to unnamed transcripts)
```{r}
duplicates <- unique(genes_present$hgnc_symbol[duplicated(genes_present$hgnc_symbol) | duplicated(genes_present$hgnc_symbol, fromLast = T)])
for (g in duplicates) {
  copies_of_g <- which(genes_present$hgnc_symbol == g)
  if (g == "") {
    for (m in 1:length(copies_of_g)) {
      genes_present$hgnc_symbol[copies_of_g[m]] <- paste0("unnamed.", genes_present$ensembl_gene_id[copies_of_g[m]])
    }
  } else {
    for (m in 1:length(copies_of_g)) {
        genes_present$hgnc_symbol[copies_of_g[m]] <- paste0(g, ".", genes_present$ensembl_gene_id[copies_of_g[m]])
    }
  }
}

rm(duplicates, copies_of_g, g, m)
```

Cut cells with less than 200 genes, genes with less than 3 cells
```{r}
cell_counts <- rowSums(expression_matrix)
expression_matrix <- expression_matrix[cell_counts >= min_cells_per_gene,]
genes_present <- genes_present[cell_counts>=min_cells_per_gene,]

gene_counts <- colSums(expression_matrix)
expression_matrix <- expression_matrix[,gene_counts>=min_genes_per_cell]
rm(cell_counts, gene_counts)
```


Make genes ready for cds construction
```{r}
genes_matrix <- data.frame(genes_present$hgnc_symbol)
rownames(genes_matrix) <- genes_present$ensembl_gene_id
colnames(genes_matrix) <- "gene_short_name"
rm(genes_present)
```

Prepare cell CDS
```{r}
demux_file <- paste0('/project2/gilad/reem/singlecellCM/round1/fulldata/CD', '1', '/CD', '1', 'col', '1', '/demux/hpCD', '1', 'col', '1', '_demux.best')
demux <- read.table(demux_file, header = T, stringsAsFactors = F, row.names = 1)

m <- match(colnames(expression_matrix), rownames(demux))
demux <- demux[m,]

# Check that all cells were run through demuxlet
if (any(is.na(m))) {
  cat(paste0("Not all barcodes are in demuxlet data. Something is wrong in CD",'1', "col", '1', "!\n"))
  expression_matrix <- expression_matrix[,!is.na(m)]
  demux <- demux[!is.na(m),]
}
```

Assign individuals
```{r}
demux$individual <- "doublet"
demux$individual[which(demux$BEST == "SNG-NA19093")] <- "NA19093"
demux$individual[which(demux$BEST == "SNG-NA18912")] <- "NA18912"
demux$individual[which(demux$BEST == "SNG-NA18858")] <- "NA18858"
demux$individual[which(demux$BEST == "SNG-NA18520")] <- "NA18520"
demux$individual[which(demux$BEST == "SNG-NA18511")] <- "NA18511"
demux$individual[which(demux$BEST == "SNG-NA18508")] <- "NA18508"
```

Create cell info matrix
```{r}
cell_metadata <- data.frame(demux$individual, row.names=rownames(demux))
colnames(cell_metadata) <- "individual"
```

Add differentiation days into cell matrix
```{r}
cell_metadata$diffday <- "NA"
cell_metadata$diffday[which(cell_metadata$individual == "NA19093")] <- "Day 7"
cell_metadata$diffday[which(cell_metadata$individual == "NA18912")] <- "Day 3"
cell_metadata$diffday[which(cell_metadata$individual == "NA18520")] <- "Day 1"
```

Add collection day into cell matrix
```{r}
cell_metadata$colday <- "1"
```

Filter out doublets and mislabeled cells
```{r}
non_doublets <- cell_metadata$individual != "doublet"
properly_labeled <- cell_metadata$diffday != "NA"
cell_metadata <- cell_metadata[non_doublets & properly_labeled,]
expression_matrix <- expression_matrix[,non_doublets & properly_labeled]
```


Save the expression matrix as a sparse matrix
```{r}
library(Matrix)
expression_sparse <- Matrix(as.matrix(expression_matrix), sparse=TRUE)
```

Create the CDS object!
```{r}
library(monocle3)
cds <- new_cell_data_set(expression_sparse,
                         cell_metadata = cell_metadata,
                         gene_metadata = genes_matrix)
```

Play around

